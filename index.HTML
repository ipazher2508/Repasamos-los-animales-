<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Exploradores: Nivel Experto</title>
    <style>
        :root {
            --color-primary: #388E3C; /* Verde hoja oscuro */
            --color-secondary: #00897B; /* Verde azulado */
            --color-accent: #FF6F00; /* √Åmbar */
            --color-bg: #E0F2F1; /* Fondo suave */
            --font-main: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            font-family: var(--font-main);
            background-color: var(--color-bg);
            margin: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
            user-select: none;
        }

        /* --- HEADER --- */
        header {
            background: linear-gradient(90deg, var(--color-primary), var(--color-secondary));
            color: white;
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }

        h1 { margin: 0; font-size: 1.6rem; letter-spacing: 1px; }

        .score-board {
            background: rgba(255,255,255,0.95);
            padding: 8px 20px;
            border-radius: 50px;
            display: flex;
            align-items: center;
            gap: 15px;
            color: #333;
            font-weight: bold;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .progress-track {
            width: 200px;
            height: 18px;
            background: #CFD8DC;
            border-radius: 10px;
            overflow: hidden;
            border: 1px solid #B0BEC5;
        }

        .progress-fill {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, #FFEB3B, #FF6F00);
            transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* --- MAIN CONTAINER --- */
        #app-container {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            justify-content: center;
            align-items: flex-start;
        }

        .screen {
            display: none;
            width: 100%;
            max-width: 1200px;
            animation: fadeIn 0.4s ease-out;
            text-align: center;
            padding-bottom: 100px;
        }

        .active { display: block; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* --- MENU CARDS --- */
        .menu-grid {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-top: 40px;
            flex-wrap: wrap;
        }

        .card-btn {
            background: white;
            border-bottom: 6px solid var(--color-secondary);
            border-radius: 15px;
            width: 260px;
            padding: 30px;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            position: relative;
            top: 0;
        }

        .card-btn:hover { top: -5px; box-shadow: 0 8px 20px rgba(0,0,0,0.1); }
        .card-btn:active { top: 2px; border-bottom-width: 2px; }
        
        .card-btn h2 { color: var(--color-primary); margin: 15px 0 5px; }
        .card-btn p { color: #666; font-size: 0.9rem; }
        .card-btn .icon { font-size: 4.5rem; }

        .game-mode { border-color: var(--color-accent); }
        .game-mode h2 { color: var(--color-accent); }

        /* --- CONTENT VIEWS --- */
        .content-box {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.05);
            text-align: left;
            margin-top: 20px;
        }

        .tab-btn {
            background: #fff;
            border: 2px solid var(--color-primary);
            color: var(--color-primary);
            padding: 10px 25px;
            border-radius: 25px;
            font-size: 1.1rem;
            cursor: pointer;
            font-weight: bold;
            margin: 5px;
            transition: all 0.2s;
        }
        
        .tab-btn:hover { background: #E8F5E9; }
        .tab-btn.selected { background: var(--color-primary); color: white; box-shadow: 0 4px 10px rgba(56, 142, 60, 0.3); }

        /* Estilos T√©cnicos */
        .tech-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 20px; margin-top: 20px; }
        .tech-item { border: 1px solid #ddd; padding: 15px; border-radius: 10px; text-align: center; }
        .tech-item strong { display: block; color: var(--color-secondary); margin-bottom: 5px; font-size: 1.1rem; }
        .tech-desc { font-size: 0.9rem; color: #555; line-height: 1.4; }

        /* Foco en Insectos */
        .insect-panel {
            background: #FFF8E1;
            border: 3px solid #FFD54F;
            border-radius: 15px;
            padding: 20px;
            margin-top: 25px;
            display: flex;
            align-items: center;
            justify-content: space-around;
        }
        .insect-parts { text-align: left; }
        .insect-parts li { margin-bottom: 8px; font-size: 1.1rem; }
        .vocabulary { font-weight: bold; color: #E65100; background: #FFE0B2; padding: 2px 6px; border-radius: 4px; }

        /* --- JUEGOS --- */
        .game-title { font-size: 1.5rem; color: #444; margin-bottom: 20px; font-weight: bold; }

        /* Quiz */
        .quiz-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .quiz-opt {
            background: white; border: 2px solid #CFD8DC; padding: 25px;
            border-radius: 15px; font-size: 1.3rem; cursor: pointer; transition: background 0.2s;
        }
        .quiz-opt:hover { background: #ECEFF1; border-color: #90A4AE; }

        /* Sort (Clasificaci√≥n) */
        .sort-area { display: flex; justify-content: center; gap: 40px; margin-top: 30px; }
        .drop-zone {
            width: 250px; height: 200px;
            border: 4px dashed; border-radius: 20px;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            font-size: 1.5rem; font-weight: bold; cursor: pointer;
            transition: transform 0.2s;
        }
        .zone-v { border-color: var(--color-primary); background: #F1F8E9; color: var(--color-primary); }
        .zone-i { border-color: var(--color-accent); background: #FFF3E0; color: var(--color-accent); }
        .zone-v:hover, .zone-i:hover { transform: scale(1.05); }

        .current-animal { font-size: 5rem; margin: 10px 0; animation: popIn 0.3s; }
        @keyframes popIn { from{transform:scale(0);} to{transform:scale(1);} }

        /* --- MODAL --- */
        #modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); backdrop-filter: blur(3px);
            display: none; justify-content: center; align-items: center; z-index: 1000;
        }
        .modal-box {
            background: white; padding: 40px; border-radius: 20px;
            text-align: center; width: 90%; max-width: 500px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            border-top: 10px solid var(--color-primary);
        }
        .modal-btn {
            background: var(--color-primary); color: white; border: none;
            padding: 12px 30px; font-size: 1.2rem; border-radius: 30px;
            cursor: pointer; margin-top: 20px;
        }

        /* --- NAV BTN --- */
        .nav-btn {
            position: fixed; bottom: 25px; left: 25px;
            background: #455A64; color: white; padding: 12px 25px;
            border: none; border-radius: 50px; font-size: 1.1rem;
            cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            z-index: 500; display: flex; align-items: center; gap: 10px;
        }

    </style>
</head>
<body>

<header>
    <h1>ü¶Å Exploradores: Edici√≥n Experto</h1>
    <div class="score-board">
        <span>Nivel de Sabidur√≠a:</span>
        <div class="progress-track">
            <div class="progress-fill" id="bar-fill"></div>
        </div>
    </div>
</header>

<div id="app-container">

    <!-- 1. INICIO -->
    <div id="screen-home" class="screen active">
        <h2 style="font-size: 2rem; color: #333;">¬øQu√© vamos a investigar hoy?</h2>
        <div class="menu-grid">
            <div class="card-btn" onclick="goTo('screen-vert')">
                <div class="icon">ü¶¥</div>
                <h2>Vertebrados</h2>
                <p>Anatom√≠a y clasificaci√≥n</p>
            </div>
            <div class="card-btn" onclick="goTo('screen-invert')">
                <div class="icon">üêô</div>
                <h2>Invertebrados</h2>
                <p>Artr√≥podos y otros grupos</p>
            </div>
            <div class="card-btn game-mode" onclick="goTo('screen-games-menu')">
                <div class="icon">üéÆ</div>
                <h2>Zona de Juegos</h2>
                <p>Demuestra lo aprendido</p>
            </div>
        </div>
    </div>

    <!-- 2. VERTEBRADOS (Contenido Profundo) -->
    <div id="screen-vert" class="screen">
        <h2>Clasificaci√≥n de Vertebrados</h2>
        <div id="vert-tabs"></div> <!-- Tabs generados por JS -->
        <div id="vert-content" class="content-box">
            <!-- Contenido din√°mico -->
        </div>
    </div>

    <!-- 3. INVERTEBRADOS (Contenido T√©cnico) -->
    <div id="screen-invert" class="screen">
        <h2>Los Invertebrados</h2>
        <div class="content-box">
            <p>Se caracterizan por no tener columna vertebral. Se dividen en 6 grandes grupos:</p>
            
            <div class="tech-grid">
                <div class="tech-item">
                    <div style="font-size:2.5rem">üßΩ</div>
                    <strong>Por√≠feros (Esponjas)</strong>
                    <span class="tech-desc">Viven fijas al suelo y filtran agua por sus poros.</span>
                </div>
                <div class="tech-item">
                    <div style="font-size:2.5rem">üéê</div>
                    <strong>Cnidarios</strong>
                    <span class="tech-desc">Medusas y an√©monas. Tienen tent√°culos venenosos.</span>
                </div>
                <div class="tech-item">
                    <div style="font-size:2.5rem">ü™±</div>
                    <strong>Gusanos</strong>
                    <span class="tech-desc">Cuerpo blando y alargado. Algunos son par√°sitos.</span>
                </div>
                <div class="tech-item">
                    <div style="font-size:2.5rem">‚≠ê</div>
                    <strong>Equinodermos</strong>
                    <span class="tech-desc">Esqueleto de placas bajo la piel (Erizos, Estrellas).</span>
                </div>
                <div class="tech-item">
                    <div style="font-size:2.5rem">üêå</div>
                    <strong>Moluscos</strong>
                    <span class="tech-desc">Cuerpo blando. Bivalvos (concha), Gaster√≥podos (caracol) y <span class="vocabulary">Cefal√≥podos</span> (pulpo).</span>
                </div>
            </div>

            <!-- ARTR√ìPODOS DESTACADOS -->
            <div class="insect-panel">
                <div style="flex:1; text-align:center;">
                    <div style="font-size:5rem;">ü¶ó</div>
                    <h3 style="color:#E65100; margin:0;">ARTR√ìPODOS</h3>
                    <small>Tienen <span class="vocabulary">Exoesqueleto</span> y patas articuladas.</small>
                </div>
                <div style="flex:2;" class="insect-parts">
                    <h4>üîç Anatom√≠a de los INSECTOS:</h4>
                    <ul>
                        <li>Tienen <strong>6 patas</strong>.</li>
                        <li>Tienen <strong>2 antenas</strong> para sentir.</li>
                        <li>Su cuerpo se divide en 3 partes:
                            <br>üëâ <span class="vocabulary">Cabeza</span>, <span class="vocabulary">T√≥rax</span> y <span class="vocabulary">Abdomen</span>.
                        </li>
                    </ul>
                    <div style="background:white; padding:10px; border-radius:10px; border:1px solid #FFCC80; font-size:0.9rem;">
                        üí° <strong>Dato Clave:</strong> Los ar√°cnidos (ara√±as) tienen 8 patas y NO tienen antenas. No son insectos.
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 4. MEN√ö DE JUEGOS -->
    <div id="screen-games-menu" class="screen">
        <h2>üéØ Selecciona tu Reto</h2>
        <div class="menu-grid">
            <div class="card-btn game-mode" onclick="initQuiz()">
                <div class="icon">üß†</div>
                <h3>Quiz T√©cnico</h3>
                <p>Preguntas de experto</p>
            </div>
            <div class="card-btn game-mode" onclick="initSort()">
                <div class="icon">‚öñÔ∏è</div>
                <h3>Clasificaci√≥n R√°pida</h3>
                <p>¬øQu√© grupo es?</p>
            </div>
            <div class="card-btn game-mode" onclick="initIntruder()">
                <div class="icon">üïµÔ∏è</div>
                <h3>El Intruso</h3>
                <p>Razonamiento l√≥gico</p>
            </div>
        </div>
    </div>

    <!-- JUEGO 1: QUIZ -->
    <div id="game-quiz" class="screen">
        <div class="game-title">Pregunta <span id="quiz-count">1</span> de 5</div>
        <div id="quiz-question" style="font-size:1.5rem; margin-bottom:30px; font-weight:bold;"></div>
        <div id="quiz-options" class="quiz-grid"></div>
    </div>

    <!-- JUEGO 2: CLASIFICACI√ìN -->
    <div id="game-sort" class="screen">
        <div class="game-title">¬°Clasifica r√°pido!</div>
        <div id="sort-display">
            <div id="sort-icon" class="current-animal"></div>
            <h2 id="sort-name" style="margin:0; font-size:2rem; color:#444;"></h2>
        </div>
        <div class="sort-area">
            <div class="drop-zone zone-v" onclick="handleSort('vert')">VERTEBRADO<br><small>(Con columna)</small></div>
            <div class="drop-zone zone-i" onclick="handleSort('invert')">INVERTEBRADO<br><small>(Sin columna)</small></div>
        </div>
    </div>

    <!-- JUEGO 3: INTRUSO -->
    <div id="game-intruder" class="screen">
        <div class="game-title" id="intruder-instruction"></div>
        <div class="menu-grid" id="intruder-container"></div>
    </div>

</div>

<!-- BOT√ìN VOLVER -->
<button class="nav-btn" onclick="goBack()">‚Ü© Volver</button>

<!-- MODAL FEEDBACK -->
<div id="modal-overlay">
    <div class="modal-box">
        <div id="fb-icon" style="font-size:4rem; margin-bottom:10px;"></div>
        <h2 id="fb-title" style="color:#333; margin:0;"></h2>
        <p id="fb-msg" style="font-size:1.2rem; color:#666; margin: 20px 0;"></p>
        <button class="modal-btn" onclick="closeModal()">Continuar</button>
    </div>
</div>

<script>
    // --- BASE DE DATOS DE CONTENIDOS (T√©cnica) ---
    const vertebradosDB = {
        'mamiferos': {
            label: 'Mam√≠feros',
            html: `<h3>Caracter√≠sticas Principales:</h3>
                   <ul>
                       <li>Son <strong>Viv√≠paros</strong>: Las cr√≠as crecen en el vientre materno.</li>
                       <li>Las hembras tienen <strong>mamas</strong> para alimentar a las cr√≠as con leche.</li>
                       <li>Respiran por <strong>pulmones</strong> (incluso los acu√°ticos).</li>
                       <li>Cuerpo cubierto de <strong>pelo</strong> (o piel lisa en cet√°ceos).</li>
                   </ul>
                   <div class="tech-grid">
                       <div class="tech-item"><div style="font-size:2.5rem">ü¶á</div><strong>Murci√©lago</strong><br>√önico mam√≠fero volador.</div>
                       <div class="tech-item"><div style="font-size:2.5rem">üê¨</div><strong>Cet√°ceos</strong><br>Delfines y ballenas (acu√°ticos).</div>
                       <div class="tech-item"><div style="font-size:2.5rem">ü¶Å</div><strong>Carn√≠voros</strong><br>Como el le√≥n o el tigre.</div>
                   </div>`
        },
        'aves': {
            label: 'Aves',
            html: `<h3>Caracter√≠sticas Principales:</h3>
                   <ul>
                       <li>Son <strong>Ov√≠paros</strong>: Ponen huevos con c√°scara.</li>
                       <li>Cuerpo cubierto de <strong>plumas</strong> que protegen y ayudan a volar.</li>
                       <li>Tienen <strong>pico</strong> (sin dientes) adaptado a su alimentaci√≥n.</li>
                       <li>Respiran por <strong>pulmones</strong>.</li>
                   </ul>
                   <div class="tech-grid">
                       <div class="tech-item"><div style="font-size:2.5rem">ü¶Ö</div><strong>Rapaces</strong><br>Cazadoras con garras fuertes.</div>
                       <div class="tech-item"><div style="font-size:2.5rem">üêß</div><strong>No voladoras</strong><br>El ping√ºino (nada) y el avestruz (corre).</div>
                   </div>`
        },
        'reptiles': {
            label: 'Reptiles',
            html: `<h3>Caracter√≠sticas Principales:</h3>
                   <ul>
                       <li>Cuerpo cubierto de <strong>escamas duras</strong> e impermeables.</li>
                       <li>Son de <strong>sangre fr√≠a</strong> (necesitan sol para calentarse).</li>
                       <li>La mayor√≠a son <strong>ov√≠paros</strong>.</li>
                       <li>Respiran por <strong>pulmones</strong>.</li>
                   </ul>
                   <div class="tech-grid">
                       <div class="tech-item"><div style="font-size:2.5rem">üêç</div><strong>Ofidios</strong><br>Serpientes (sin patas).</div>
                       <div class="tech-item"><div style="font-size:2.5rem">üê¢</div><strong>Quelonios</strong><br>Tortugas (con caparaz√≥n).</div>
                   </div>`
        },
        'anfibios': {
            label: 'Anfibios',
            html: `<h3>Caracter√≠sticas Principales:</h3>
                   <ul>
                       <li>Sufren <strong>METAMORFOSIS</strong>: Cambio dr√°stico de larva a adulto.</li>
                       <li>Piel <strong>desnuda</strong> y siempre h√∫meda (respiraci√≥n cut√°nea).</li>
                       <li><strong>Renacuajos:</strong> Viven en agua, respiran por <span class="vocabulary">branquias</span>.</li>
                       <li><strong>Adultos:</strong> Viven en tierra/agua, respiran por <span class="vocabulary">pulmones y piel</span>.</li>
                   </ul>`
        },
        'peces': {
            label: 'Peces',
            html: `<h3>Caracter√≠sticas Principales:</h3>
                   <ul>
                       <li>Son acu√°ticos y respiran el ox√≠geno del agua por <strong>branquias</strong>.</li>
                       <li>Tienen <strong>aletas</strong> para nadar y cuerpo con <strong>escamas</strong>.</li>
                       <li>Pueden tener esqueleto de hueso (trucha) o de cart√≠lago (tibur√≥n).</li>
                   </ul>`
        }
    };

    // --- DATOS DE JUEGOS (Nivel Profundo) ---
    const quizzes = [
        { q: "¬øQu√© partes forman el cuerpo de un insecto?", opts: ["Cabeza, Cuerpo y Cola", "Cabeza, T√≥rax y Abdomen", "Cefalot√≥rax y Abdomen"], a: 1, hint: "Recuerda: Son tres partes bien diferenciadas." },
        { q: "¬øC√≥mo respiran los renacuajos antes de ser adultos?", opts: ["Por pulmones", "Por branquias", "Por la nariz"], a: 1, hint: "Viven bajo el agua como los peces, as√≠ que usan..." },
        { q: "Los animales que nacen del vientre de la madre se llaman...", opts: ["Viv√≠paros", "Ov√≠paros", "Omn√≠voros"], a: 0, hint: "Vivi- viene de 'vivir' dentro de la mam√°." },
        { q: "¬øCu√°l de estos NO es un insecto?", opts: ["La hormiga", "La mosca", "La ara√±a"], a: 2, hint: "Cuenta las patas. Si tiene 8, es un ar√°cnido." },
        { q: "¬øQu√© grupo de invertebrados tiene tent√°culos venenosos?", opts: ["Por√≠feros (Esponjas)", "Cnidarios (Medusas)", "Equinodermos"], a: 1, hint: "Son de cuerpo gelatinoso y viven en el mar." }
    ];

    const sortData = [
        { n: "Medusa", i: "üéê", t: "invert", info: "Es un Cnidario, sin huesos." },
        { n: "Delf√≠n", i: "üê¨", t: "vert", info: "Tiene columna vertebral, es un mam√≠fero." },
        { n: "Escarabajo", i: "ü™≤", t: "invert", info: "Tiene exoesqueleto, no huesos internos." },
        { n: "Salamandra", i: "ü¶é", t: "vert", info: "Es un anfibio, tiene esqueleto." },
        { n: "Estrella de Mar", i: "‚≠ê", t: "invert", info: "Es un Equinodermo." }
    ];

    const intruderData = [
        { title: "Encuentra al que NO respira por pulmones", cards: [{i:"üêï", ok:false}, {i:"ü¶Ö", ok:false}, {i:"üêü", ok:true}], hint: "El pez usa branquias." },
        { title: "Encuentra al Ar√°cnido (8 patas)", cards: [{i:"üêú", ok:false}, {i:"üï∑Ô∏è", ok:true}, {i:"ü¶ó", ok:false}], hint: "La ara√±a no es un insecto." },
        { title: "Encuentra al Mam√≠fero Ov√≠paro (¬°Raro!)", cards: [{i:"üêÑ", ok:false}, {i:"ü¶Ü", ok:false}, {i:"ü¶¶", ok:true}], hint: "El ornitorrinco es mam√≠fero pero pone huevos (aqu√≠ representado por su primo acu√°tico para el ejemplo, o usa imaginaci√≥n)." } 
        // Nota: Simplifiqu√© el √∫ltimo para evitar confusi√≥n visual sin icono de ornitorrinco, cambiemos a uno m√°s claro:
    ];
    // Ajuste en caliente del dato 3 para icono disponible:
    intruderData[2] = { title: "Busca el animal que sufre Metamorfosis", cards: [{i:"üê∏", ok:true}, {i:"üê∂", ok:false}, {i:"üê¶", ok:false}], hint: "Nace como renacuajo y cambia totalmente." };


    // --- GESTI√ìN DE ESTADO ---
    let currentScore = 0;
    let navHistory = ['screen-home'];
    let gameIndex = 0;
    let currentMode = '';
    let isGameFinished = false; // Flag para controlar el fin del juego

    // --- INICIALIZACI√ìN ---
    window.onload = function() {
        const tabs = document.getElementById('vert-tabs');
        Object.keys(vertebradosDB).forEach(key => {
            const btn = document.createElement('button');
            btn.className = 'tab-btn';
            btn.innerText = vertebradosDB[key].label;
            btn.onclick = () => loadVertContent(key, btn);
            tabs.appendChild(btn);
        });
        loadVertContent('mamiferos', tabs.firstChild);
    };

    function loadVertContent(key, btn) {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('selected'));
        btn.classList.add('selected');
        document.getElementById('vert-content').innerHTML = vertebradosDB[key].html;
    }

    // --- SISTEMA DE NAVEGACI√ìN ---
    function goTo(screenId) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById(screenId).classList.add('active');
        
        // Gesti√≥n del historial
        if (navHistory[navHistory.length - 1] !== screenId) {
            navHistory.push(screenId);
        }
    }

    function goBack() {
        if (navHistory.length > 1) {
            navHistory.pop(); // Sacar actual
            const prev = navHistory[navHistory.length - 1];
            
            // L√≥gica especial: Si vuelvo de un juego EN CURSO, voy al men√∫ de juegos
            if (prev.startsWith('game-')) {
                goTo('screen-games-menu');
            } else {
                goTo(prev);
            }
        }
    }

    // --- L√ìGICA DE JUEGOS ---

    // 1. QUIZ
    function initQuiz() {
        currentMode = 'quiz'; gameIndex = 0; isGameFinished = false;
        goTo('game-quiz'); loadQuizStep();
    }
    function loadQuizStep() {
        if (gameIndex >= quizzes.length) { finishGame(); return; }
        
        const data = quizzes[gameIndex];
        document.getElementById('quiz-count').innerText = gameIndex + 1;
        document.getElementById('quiz-question').innerText = data.q;
        
        const container = document.getElementById('quiz-options');
        container.innerHTML = '';
        data.opts.forEach((opt, idx) => {
            const div = document.createElement('div');
            div.className = 'quiz-opt';
            div.innerText = opt;
            div.onclick = () => checkQuiz(idx, data);
            container.appendChild(div);
        });
    }
    function checkQuiz(idx, data) {
        if (idx === data.a) handleCorrect();
        else handleFail(data.hint);
    }

    // 2. SORT
    function initSort() {
        currentMode = 'sort'; gameIndex = 0; isGameFinished = false;
        goTo('game-sort'); loadSortStep();
    }
    function loadSortStep() {
        if (gameIndex >= sortData.length) { finishGame(); return; }
        const data = sortData[gameIndex];
        document.getElementById('sort-icon').innerText = data.i;
        document.getElementById('sort-name').innerText = data.n;
    }
    function handleSort(type) {
        const data = sortData[gameIndex];
        if (type === data.t) handleCorrect();
        else handleFail("¬°Ups! " + data.info);
    }

    // 3. INTRUDER
    function initIntruder() {
        currentMode = 'intruder'; gameIndex = 0; isGameFinished = false;
        goTo('game-intruder'); loadIntruderStep();
    }
    function loadIntruderStep() {
        if (gameIndex >= intruderData.length) { finishGame(); return; }
        const data = intruderData[gameIndex];
        document.getElementById('intruder-instruction').innerText = data.title;
        const container = document.getElementById('intruder-container');
        container.innerHTML = '';
        data.cards.forEach(card => {
            const div = document.createElement('div');
            div.className = 'card-btn';
            div.style.width = '150px';
            div.innerHTML = `<div style="font-size:4rem">${card.i}</div>`;
            div.onclick = () => {
                if (card.ok) handleCorrect();
                else handleFail(data.hint);
            };
            container.appendChild(div);
        });
    }

    // --- FEEDBACK Y CONTROL ---
    function handleCorrect() {
        currentScore = Math.min(currentScore + 10, 100);
        document.getElementById('bar-fill').style.width = currentScore + '%';
        showFeedback(true, "¬°Correcto!", "¬°Eres un hacha!");
        gameIndex++;
    }

    function handleFail(hint) {
        showFeedback(false, "Pi√©nsalo mejor...", hint);
    }

    function finishGame() {
        isGameFinished = true;
        showFeedback(true, "¬°Nivel Completado! üèÜ", "Has superado este reto. Volvamos a elegir otro.");
    }

    function showFeedback(success, title, msg) {
        const modal = document.getElementById('modal-overlay');
        document.getElementById('fb-icon').innerText = success ? 'üåü' : 'üßê';
        document.getElementById('fb-title').innerText = title;
        document.getElementById('fb-msg').innerText = msg;
        modal.style.display = 'flex';
        modal.dataset.success = success;
    }

    function closeModal() {
        document.getElementById('modal-overlay').style.display = 'none';
        const success = document.getElementById('modal-overlay').dataset.success === "true";

        if (isGameFinished) {
            // SOLUCI√ìN AL BUG: Si el juego acab√≥, volvemos al men√∫
            goTo('screen-games-menu');
            isGameFinished = false; // Reset flag
        } else if (success) {
            // Si acert√≥ pero no ha acabado el juego, siguiente pregunta
            if (currentMode === 'quiz') loadQuizStep();
            if (currentMode === 'sort') loadSortStep();
            if (currentMode === 'intruder') loadIntruderStep();
        }
        // Si fall√≥ (success = false), no hacemos nada, se queda en la misma pantalla para reintentar.
    }

</script>

</body>
</html>